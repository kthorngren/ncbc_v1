<!DOCTYPE html>
<html>
  <head>

    <meta name = "viewport" content = "width = device-width, initial-scale = 1.0">
    <title id="page-title">NC Brewers Cup</title>
    <!-- Datatables Bootstrap Buttons RowGroup Select -->
    <link rel="stylesheet" type="text/css" href="static/css/datatables.min.css"/>
    <!-- DataTables Editor -->
    <link rel="stylesheet" type="text/css" href="static/css/editor.bootstrap.min.css">
    <!-- Bootstrap Toggle -->
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap-toggle.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" type="text/css" href="static/css/select2.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="static/css/font-awesome.min.css">
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="static/css/bootstrap-select.min.css">

    <!-- Custom Theme Style -->
    <link rel="stylesheet" type="text/css" href="static/css/custom.min.css">


  </head>

  <style>


  </style>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <!-- sidebar -->
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index" class="site_title"><i class="fa fa-home"></i> <span id="nav-title"> NC Brewers Cup</span></a>
            </div>
            <div class="clearfix"></div>
            <!-- sidebar menu -->
            <!-- /sidebar menu -->

          </div>
        </div>
        <!-- sidebar -->


        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav class="" role="navigation">
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>
            </nav>
          </div>
        </div>



        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h4 id='main-title'>Manage People</h4>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">

                <div class="x_panel">
                  <div class="x_title">
                    <h2 id="table-title">Flights</h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                      </li>
                      <!--
                      <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                        <ul class="dropdown-menu" role="menu">
                          <li><a href="#">Settings 1</a>
                          </li>
                          <li><a href="#">Settings 2</a>
                          </li>
                        </ul>
                      </li>
                      -->
                      <li><a class="close-link"><i class="fa fa-close"></i></a>
                      </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <p class="text-muted font-13 m-b-30">Place instructions here</p>
    			  </div>
                          <table id="main-table" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th>Flight</th>
                                <th>Category</th>
                                <th>Sub Category</th>
                                <th>Number of Entries</th>
                                <th>Tables</th>
                                <th>Cat Total</th>
                              </tr>
	                        </thead>
                          </table>
                </div>
                <!-- /x_panel -->



                <div class="x_panel">
                  <div class="x_title">
                    <h2 id="table-title">Judges</h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                      </li>
                      <!--
                      <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                        <ul class="dropdown-menu" role="menu">
                          <li><a href="#">Settings 1</a>
                          </li>
                          <li><a href="#">Settings 2</a>
                          </li>
                        </ul>
                      </li>
                      -->
                      <li><a class="close-link"><i class="fa fa-close"></i></a>
                      </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <p class="text-muted font-13 m-b-30">Place instructions here</p>
    			  </div>
                          <table id="child-table" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th>pkid</th>
                                <th>Table Name</th>
                                <th>Session</th>
                                <th>Head Judge</th>
                                <th>Second Judge</th>
                                <th>Number Beers</th>
                              </tr>
	                        </thead>
                          </table>
                </div>
                <!-- /x_panel -->

              </div>
            </div>
            <!-- /row -->




          </div>
        </div>
        <!-- /page content -->



        <!-- footer content -->
        <footer class="right_col_background">
          <div class="pull-right right_col_background">
            NC Brewers Cup
          </div>
          <div class="clearfix right_col_background"></div>
        </footer>
        <!-- /footer content -->

      </div>
    </div>



    <!-- jQuery -->
    <script src="static/js/jquery-3.3.1.min.js"></script>
	<!-- debounce -->
    <script src="static/js/jquery.ba-throttle-debounce.min.js"></script>
    <!-- Datatables Bootstrp Buttons RowGroup Select-->
	<script type="text/javascript" src="static/js/pdfmake.min.js"></script>
	<script type="text/javascript" src="static/js/vfs_fonts.js"></script>
	<script type="text/javascript" src="static/js/datatables.min.js"></script>
    <!-- DataTables Editor -->
    <script type="text/javascript" src="static/js/dataTables.editor.min.js"></script>
    <script type="text/javascript" src="static/js/editor.bootstrap.min.js"></script>
    <!-- Select2 -->
    <script type="text/javascript" src="static/js/editor.select2.js"></script>
    <script type="text/javascript" src="static/js/select2.min.js"></script>
    <!-- Natrural -->
    <script type="text/javascript" src="static/js/natural.js"></script>
    <!-- Bootstrap Toggle -->
    <script type="text/javascript" src="static/js/bootstrap-toggle.min.js"></script>
      <!-- Latest compiled and minified JavaScript -->
      <script src="static/js/bootstrap-select.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="/static/js/custom.min.js"></script>
    <!-- fieldType.toggle -->
    <script src="/static/js/field_type_toggle_plugin.js"></script>



<script>

var editor;

var table;
var child_table;

function initMainEditor() {

editor = new $.fn.dataTable.Editor(
{
    table: "#main-table",
	ajax: "dt_pull_sheets",
	idSrc: 'pkid',
    fields: [
        {
            name: "pkid",
            label: "pkid:",
            type: "hidden"
        },
        {
            name: "firstname",
            label: "Firstname:"
        },
        {
            name: "lastname",
            label: "Lastname:",
        },
        {
            name: "email",
            label: "Email:"
        },
        {
            name: "address",
            label: "Address:",
        },
        {
            name: "address2",
            label: "Address 2:"
        },
        {
            name: "city",
            label: "City:",
        },
        {
            name: "state",
            label: "State:"
        },
        {
            name: "zip",
            label: "Zip:",
        },
        {
            name: "country",
            label: "Country:"
        },
        {
            name: "phone",
            label: "Phone:",
        },
        {
            name: "nickname",
            label: "Nickname:"
        },
        {
            name: "bjcp_id",
            label: "BJCP ID:",
        },
        {
            name: "bjcp_rank",
            label: "BJCP Rank:"
        },
        {
            name: "cicerone",
            label: "Cicerone:",
        },
        {
            name: "alias",
            label: "Alias:"
        },
    ]
});

    /*
    // Activate an inline edit on click of a table cell
    $('#main-table').on( 'click', 'tbody td:not(:first-child, :nth-child(2))', function (e) {
        editor.inline( this, {
            onBlur: 'submit'
        } );
    } );

    */

    editor
        .on( 'postCreate postRemove', function () {
            // After create or edit, a number of other rows might have been effected -
            // so we need to reload the table, keeping the paging in the current position
            table.ajax.reload( null, false );
        } )
        .on( 'initCreate', function () {
            // Enable order for create
            editor.field( 'pkid' ).disable();
        } )
        .on( 'initEdit', function () {
            // Disable for edit (re-ordering is performed by click and drag)
            editor.field( 'pkid' ).disable();
        } );

}


function drawMainTable() {
	table = $('#main-table').DataTable({
    ajax: {
			url: 'dt_pull_sheets',
			dataSrc: function (data) {
				for (var i=0; i<data.data.length; i++) {
					data.data[i].tables = JSON.parse(data.data[i].tables);
				}
				return data.data;
			}
		},
		dom: 'Blftirp',
		rowId: 'pkid',
	    select: {
    	    style: "single",
        	selector: "td:first-child"
   		},
   		order: [[0, 'asc']],
      columns: [
  	        {
  	        	data: 'number',
  	        },
  	        {
  	        	data: 'category',
  	        	visible: false
  	        },
  	        {
  	        	data: 'style',
  	        },
  	        {
  	        	data: 'count',
  	        },
  	        {
  	        	data: 'tables',
  	        	render: function (data, type, row) {
  	        		if (type === 'display') {
  	        			if (row.judged == 1) {
  	        				return 'Judged'
  	        			}
  	        			table_num = '';
  	        			if (data.sort()) {
  	        				for (var i=0; i<data.length; i++) {
  	        					var element = data[i];
  	        					var temp = table_num ? ',' + element.split(' ').slice(-1)[0] : element.split(' ').slice(-1)[0];
  	        			 		table_num = table_num + temp;
  	        				}
  	        			} else {
  	        				table_num = '';
  	        			}
  	        			return  table_num;
  	        		}
  	        		return data;
  	        	}
  	        },
  	        {
  	        	data: 'cat_total',
  	        	defaultContent: 0,
  	        	visible: false
  	        },
  	    ],
	    buttons: [
        { extend: "create", editor: editor },
        { extend: "edit",   editor: editor },
            {
                extend: "selectedSingle",
                text: 'Duplicate',
                action: function ( e, dt, node, config ) {
                    // Place the selected row into edit mode (but hidden),
                    // then get the values for all fields in the form
                    var values = editor.edit(
                            table.row( { selected: true } ).index(),
                            false
                        )
                        .val();

                    // Create a new entry (discarding the previous edit) and
                    // set the values from the read values
                    editor
                        .create( {
                            title: 'Duplicate record',
                            buttons: 'Create from existing'
                        } )
                        .set( values );
                }
            },
        { extend: "remove", editor: editor }
    ],

    rowGroup: {
      dataSrc: 'number',
          startRender: function ( rows, group ) {
              //console.log(group)
            var sum = rows
                  .data()
                  .pluck('count')
                  .reduce( function (a, b) {
                  return a + b;
                }, 0 );

            var num_tables = rows
                  .data()
                  .pluck('tables')
                  .reduce( function (a, b) {

                  return a + (b ? b.length : 0);
                }, 0 );


              var avg_beers = 0;

              if (rows[0].length > 0) {
                avg_beers = num_tables / rows[0].length;
              }

              if (avg_beers) {
                avg_beers = (sum / avg_beers).toFixed(1);
              }

      return $('<tr/>')
                  .append( '<td colspan="2	">Flight Number: ' + group + ' </td>' )
                  .append( '<td>Cat Total: ' + sum.toFixed(0) + '</td>' )
                  .append( '<td>' + avg_beers + '</td>' );
        }
    },

	});


}


function drawChildTable() {
	child_table = $('#child-table').DataTable({
    ajax: "dt_tables",
		dom: 't',
		rowId: 'pkid',
		paging: false,
   		order: [[1, 'asc']],
	    select: {
    	    style: "single",
        	selector: "td:first-child"
   		},
      search: {
        search: "^$",
        regex: true
      },
		columns: [
	        {
	        	data: 'pkid',
	        	defaultContent: '',
	        	visible: false
	        },
	        {
	        	data: 'name', type: 'natural'
	        },
	        {
	        	data: 'session_name',
	        	visible: false
	        },
	        {
	        	data: 'head_judge',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			var bjcp = '';
	        			if (data.bjcp_rank) {
	        				bjcp = ' : BJCP ' + data.bjcp_rank;
	        			}

	        			var cat = '';
	        			if (data.categories.length > 0) {
	        				cat = ' (' + data.categories.join() + ')';
	        			}
	        			return data.firstname + ' ' + data.lastname + bjcp + cat;
	        		}
	        		return data;
	        	}
	        },
	        {
	        	data: 'second_judge',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			var bjcp = '';
	        			if (data.bjcp_rank) {
	        				bjcp = ' : BJCP ' + data.bjcp_rank;
	        			}

	        			var cat = '';
	        			if (data.categories.length > 0) {
	        				cat = ' (' + data.categories.join() + ')';
	        			}
	        			return data.firstname + ' ' + data.lastname + bjcp + cat;
	        		}
	        		return data;
	        	}
	        },
	        {
	        	data: 'total',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			return data.toFixed(1)
	        		}
	        		return data;
	        	}
	        },
	    ],

	});

}


$(document).ready(function() {
	initMainEditor();
	drawMainTable();
  drawChildTable();


  $('#main-table').on('click', '.group', function() {

    var row = $(this).closest('tr');
    //console.log(row.text().split(' '))
  	var flightId = row.text().split(' ')[2];

    //console.log(flightId)

    var indexes = table
      .rows()
      .indexes()
      .filter( function ( value, index ) {
        return flightId == table.row(value).data().number;
      } );

    //console.log(indexes)

    var data = table.rows(indexes).data();

    //console.log(data[0]);

    judgeTables = data[0].tables.join('\\b|\\b');

    console.log(judgeTables)

    if (judgeTables.length > 0) {
      child_table.search('\\b' + judgeTables + '\\b', true, false).draw();
    } else {
      child_table.search("^$", true, false).draw();
    }
    //child_table.search()

  });

});
</script>

</body>
</html>
