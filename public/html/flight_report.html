<!DOCTYPE html>
<html>
  <head>

    <meta name = "viewport" content = "width = device-width, initial-scale = 1.0">
    <title id="page-title">NC Brewers Cup</title>
    <!-- Datatables Bootstrap Buttons RowGroup Select -->
    <link rel="stylesheet" type="text/css" href="static/css/datatables.min.css"/>
    <!-- DataTables Editor -->
    <link rel="stylesheet" type="text/css" href="static/css/editor.bootstrap.min.css">
    <!-- Bootstrap Toggle -->
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap-toggle.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" type="text/css" href="static/css/select2.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="static/css/font-awesome.min.css">
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="static/css/bootstrap-select.min.css">

    <!-- Custom Theme Style -->
    <link rel="stylesheet" type="text/css" href="static/css/custom.min.css">

  </head>

  <style>


  </style>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <!-- sidebar -->
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index" class="site_title"><i class="fa fa-home"></i> <span id="nav-title"> NC Brewers Cup</span></a>
            </div>
            <div class="clearfix"></div>
            <!-- sidebar menu -->
            <!-- /sidebar menu -->

          </div>
        </div>
        <!-- sidebar -->


        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav class="" role="navigation">
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>
            </nav>
          </div>
        </div>



        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h4 id='main-title'>Sessions Editor</h4>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">

                <div class="x_panel">
                  <div class="x_title">
                    <h2 id="table-title">Sessions</h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                      </li>
                      <!--
                      <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                        <ul class="dropdown-menu" role="menu">
                          <li><a href="#">Settings 1</a>
                          </li>
                          <li><a href="#">Settings 2</a>
                          </li>
                        </ul>
                      </li>
                      -->
                      <li><a class="close-link"><i class="fa fa-close"></i></a>
                      </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <p class="text-muted font-13 m-b-30">Place instructions here</p>
    			  </div>
                          <table id="main-table" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th>pkid</th>
                                <th></th>
                                <th>Name</th>
                                <th>Judging</th>
                                <th>Setup</th>
                                <th>BOS</th>
                                <th>Session Day</th>
                                <th>Session Number</th>
                                <th>Session Start</th>
                                <th>Session End</th>
                              </tr>
	                        </thead>
                          </table>
                </div>
                <!-- /x_panel -->

              </div>
            </div>
            <!-- /row -->


            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">

                <div class="x_panel">
                  <div class="x_title">
                    <h2 id="table-title">Potential People to Assign Email</h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                      </li>
                      <!--
                      <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                        <ul class="dropdown-menu" role="menu">
                          <li><a href="#">Settings 1</a>
                          </li>
                          <li><a href="#">Settings 2</a>
                          </li>
                        </ul>
                      </li>
                      -->
                      <li><a class="close-link"><i class="fa fa-close"></i></a>
                      </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <p class="text-muted font-13 m-b-30">Place child instructions here</p>
    			  </div>
                          <table id="child-table" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th>Flight</th>
                                <th>Category</th>
                                <th>Sub Category</th>
                                <th>Number of Entries</th>
                                <th>Tables</th>
                                <th>Cat Total</th>
                              </tr>
	                        </thead>
                          </table>
                </div>
                <!-- /x_panel -->

              </div>
            </div>
            <!-- /row -->


          </div>
        </div>
        <!-- /page content -->



        <!-- footer content -->
        <footer class="right_col_background">
          <div class="pull-right right_col_background">
            NC Brewers Cup
          </div>
          <div class="clearfix right_col_background"></div>
        </footer>
        <!-- /footer content -->

      </div>
    </div>



    <!-- jQuery -->
    <script src="static/js/jquery-3.3.1.min.js"></script>
	<!-- debounce -->
    <script src="static/js/jquery.ba-throttle-debounce.min.js"></script>
    <!-- Datatables Bootstrp Buttons RowGroup Select-->
	<script type="text/javascript" src="static/js/pdfmake.min.js"></script>
	<script type="text/javascript" src="static/js/vfs_fonts.js"></script>
	<script type="text/javascript" src="static/js/datatables.min.js"></script>
    <!-- DataTables Editor -->
    <script type="text/javascript" src="static/js/dataTables.editor.min.js"></script>
    <script type="text/javascript" src="static/js/editor.bootstrap.min.js"></script>
    <!-- Select2 -->
    <script type="text/javascript" src="static/js/editor.select2.js"></script>
    <script type="text/javascript" src="static/js/select2.min.js"></script>
    <!-- Bootstrap Toggle -->
    <script type="text/javascript" src="static/js/bootstrap-toggle.min.js"></script>
      <!-- Latest compiled and minified JavaScript -->
      <script src="static/js/bootstrap-select.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="/static/js/custom.min.js"></script>
    <!-- fieldType.toggle -->
    <script src="/static/js/field_type_toggle_plugin.js"></script>



<script>


var table;
var child_table;


function drawMainTable() {
	table = $('#main-table').DataTable({
		ajax: 'dt_flight_report',
		dom: 'Bftir',
		paging: false,
		rowId: 'pkid',
	    select: {
    	    style: "single",
        	selector: "td:first-child"
   		},
   		order: [[6, 'asc']],
		columns: [
	        {
	        	data: 'pkid',
	        	visible: false
	        },
	        {
    	        data: null,
        	    defaultContent: "",
            	className: "select-checkbox",
	            orderable: false
    	    },
	        {
	        	data: 'name',
	        },
	        {
	        	data: 'judging',
	        	render: function ( data, type, row )
	        		{
	        			if ( type === 'display' ) {
	        				return '<input type="checkbox" class="judging-enabled">';
	        			}
	        			return data;
	        		},
            	className: "dt-body-center"
	        },
	        {
	        	data: 'setup',
	        	render: function ( data, type, row )
	        		{
	        			if ( type === 'display' ) {
	        				return '<input type="checkbox" class="setup-enabled">';
	        			}
	        			return data;
	        		},
            	className: "dt-body-center"
	        },
	        {
	        	data: 'bos',
	        	render: function ( data, type, row )
	        		{
	        			if ( type === 'display' ) {
	        				return '<input type="checkbox" class="bos-enabled">';
	        			}
	        			return data;
	        		},
            	className: "dt-body-center"
	        },
	        {
	        	data: 'day',
	        },
	        {
	        	data: 'session_number',
	        },
	        {
	        	data: 'session_start',
	        },
	        {
	        	data: 'session_end',
	        },
	    ],

	    rowCallback: function ( row, data )
	    	{
	    		console.log('judging', data.judging);
	    		$('input.judging-enabled', row).prop( 'checked', data.judging == 1 );
	    		$('input.setup-enabled', row).prop( 'checked', data.setup == 1 );
	    		$('input.bos-enabled', row).prop( 'checked', data.bos == 1 );
	    	},

	});


}




function drawChildTable() {
	child_table = $('#child-table').DataTable({
		ajax: {
			url: 'dt_flights',
			dataSrc: function (data) {
				for (var i=0; i<data.data.length; i++) {
					data.data[i].tables = JSON.parse(data.data[i].tables);
				}
				return data.data;
			}
		},
		dom: 't',
		paging: false,
		//scrollY: 1500,
	    select: {
    	    style: "single",
        	selector: "td:last-child"
   		},
   		order: [[1, 'asc'], [2, 'asc']],
		columns: [
	        {
	        	data: 'number',
	        },
	        {
	        	data: 'category',
	        	visible: false
	        },
	        {
	        	data: 'style',
	        },
	        {
	        	data: 'count',
	        },
	        {
	        	data: 'tables',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			if (row.judged == 1) {
	        				return 'Judged'
	        			}
	        			table_num = '';
	        			if (data.sort()) {
	        				for (var i=0; i<data.length; i++) {
	        					var element = data[i];
	        					var temp = table_num ? ',' + element.split(' ').slice(-1)[0] : element.split(' ').slice(-1)[0];
	        			 		table_num = table_num + temp;
	        				}
	        			} else {
	        				table_num = '';
	        			}
	        			return  table_num;
	        		}
	        		return data;
	        	}
	        },
	        {
	        	data: 'cat_total',
	        	defaultContent: 0,
	        	visible: false
	        },
	    ],
	    rowGroup: {
	    	dataSrc: 'category',
            startRender: function ( rows, group ) {

            	var sum = rows
                    .data()
                    .pluck('count')
                    .reduce( function (a, b) {
                    return a + b;
                	}, 0 );

            	var num_tables = rows
                    .data()
                    .pluck('tables')
                    .reduce( function (a, b) {

                    return a + (b ? b.length : 0);
                	}, 0 );


                var avg_beers = 0;

                if (rows[0].length > 0) {
                	avg_beers = num_tables / rows[0].length;
                }

                if (avg_beers) {
                	avg_beers = (sum / avg_beers).toFixed(1);
                }

				return $('<tr/>')
                    .append( '<td colspan="2	">' + group + '</td>' )
                    .append( '<td>Cat Total: ' + sum.toFixed(0) + '</td>' )
                    .append( '<td>' + avg_beers + '</td>' );
         	}
	    },
	    rowCallback: function (row, data) {
	    	//console.log(judge_entries);
	    	//console.log(judge_likes);
	    	//console.log(judge_dislikes);

	    	//$(row).data(data);
	    	/*
	    	if (data.judged == 1) {
				$(row).addClass('strikeout');

	    	} else if (judge_entries.indexOf(data.category_id.toString()) > -1) {
				$(row).css('color', 'Red');
				$(row).attr('title', 'Entry');
			} else if (judge_dislikes.indexOf(data.category_id.toString()) > -1){
				$(row).css('color', 'Red');
				$(row).attr('title', 'Dislikes');
			} else if (judge_likes.indexOf(data.category_id.toString()) > -1){
				$(row).css('color', 'Green');
				$(row).attr('title', 'Likes');
			} else {
				$(row).css('color', '');
				$(row).attr('title');
			}
      */
	    },
    	columnDefs: [
      		{
      			targets: ['_all'],
      			orderable: false
      		}

    	],
    	drawCallback: function( settings ) {
        	var api = this.api();
        	var category_totals = {};

			api.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
    			var data = this.data();

    			if (!category_totals[data.category_id]) {
    				category_totals[data.category_id] = 0;
    			}
    			category_totals[data.category_id] = category_totals[data.category_id] + data.count;
			} );

			api.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
    			var data = this.data();

    			data.cat_total = category_totals[data.category_id];
    			this.data(data);
			} );


        },
	    buttons: [
            {
                text: 'Initialize Flights',
                action: function ( e, dt, node, config ) {

    				init_flights(true);


                }
            },
            {
                text: 'Use Registered Count',
                action: function ( e, dt, node, config ) {

    				get_styles_count(true);


                }
            },
            {
                text: 'Use Inventory Count',
                action: function ( e, dt, node, config ) {

					get_styles_count(false);

                }
            },
            {
                text: 'Save Flights',
                action: function ( e, dt, node, config ) {
                	save_flights();
                }
            },
            {
                text: 'Order by Category',
                action: function ( e, dt, node, config ) {
                	table.order([[1, 'asc'], [2, 'asc']]).draw(false);
                }
            },
            {
                text: 'Order by Cat Totals',
                action: function ( e, dt, node, config ) {
                	table.order([[5, 'desc'], [1, 'asc'], [2, 'asc']]).draw(false);
                }
            },
            {
                text: 'Refresh Flights Data',
                action: function ( e, dt, node, config ) {
                	table.draw(false);
                }
            },
    ]


	});


}




$(document).ready(function() {
	drawMainTable();
	drawChildTable();

	table.on( 'select', function ( e, dt, type, indexes ) {

    	if ( type === 'row' ) {
        	var data = table.row( {selected: true} ).data();

		    $.ajax({
		      	url: "/find_person",
		      	type: 'post',
		      	data: {email: data.email, display_name: data.display_name},
		      	success: function(json) {
		            var data = JSON.parse(json);

		            child_table.clear().rows.add( data ).draw();

				},
				error: function (jqXHR, exception) {

					//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
				},

			})

    	}
	} );

	table.on( 'deselect', function ( e, dt, type, indexes ) {

    	if ( type === 'row' ) {

        	child_table.clear().draw();
    	}
	} );

});
</script>

</body>
</html>
