<!DOCTYPE html>
<html>
  <head>

    <meta name = "viewport" content = "width = device-width, initial-scale = 1.0">
    <title id="page-title">NC Brewers Cup</title>
    <!-- Datatables Bootstrap Buttons RowGroup Select -->
    <link rel="stylesheet" type="text/css" href="static/css/datatables.min.css"/>
    <!-- DataTables Editor -->
    <link rel="stylesheet" type="text/css" href="static/css/editor.bootstrap.min.css">
    <!-- Bootstrap Toggle -->
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap-toggle.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" type="text/css" href="static/css/select2.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="static/css/font-awesome.min.css">
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="static/css/bootstrap-select.min.css">

    <!-- Custom Theme Style -->
    <link rel="stylesheet" type="text/css" href="static/css/custom.min.css">

  </head>

  <style>

tr.strikeout {
  text-decoration: line-through;
}

.container {
  display: flex;
  justify-content: space-around;
  align-items: flex-start;

}


.session {
  position: -webkit-sticky;
  position: sticky;
  top: 0;
}

  </style>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <!-- sidebar -->
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index" class="site_title"><i class="fa fa-home"></i> <span id="nav-title"> NC Brewers Cup</span></a>
            </div>
            <div class="clearfix"></div>
            <!-- sidebar menu -->
            <!-- /sidebar menu -->

          </div>
        </div>
        <!-- sidebar -->


        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav class="" role="navigation">
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>
            </nav>
          </div>
        </div>



        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h4 id='main-title'>Manage Flights</h4>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">


				  <!-- col-md-6 -->
                  <div class="col-md-6 col-sm-6 col-xs-12">

                    <!-- x_panel -->
                    <div class="x_panel tile fixed_height_420">
                      <!-- panel -->
                      <div id="tests-panel" class="panel panel-default">

                      <!-- x_title -->
                      <div class="x_title panel-heading">
                        <h2 id="tests-desc">Flights<small id="tests-desc-small"></small></h2>

                        <ul class="nav navbar-right panel_toolbox">
                          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                          </li>
                          <li><a class="close-link"><i class="fa fa-close"></i></a>
                          </li>
                        </ul>
                        <div class="clearfix"></div>

                      </div>
                      <!-- /x_title -->

                      </div>
                      <!-- /panel -->


					  <!-- x_content -->
                      <div class="x_content panel-body">

                        <div class="col-md-12 hidden-small">
                          <table id="main-table" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th>Flight</th>
                                <th>Category</th>
                                <th>Sub Category</th>
                                <th>Number of Entries</th>
                                <th>Tables</th>
                                <th>Cat Total</th>
                              </tr>
                            </thead>
                          </table>


                        </div>

                      </div>
                      <!-- /x_content -->


                    </div>
                    <!-- /x_panel -->

                    </div>
                    <!-- /col-md-6 -->





 				  <!-- col-md-6 -->
                  <div class="col-md-6 col-sm-6 col-xs-12  session">

                    <!-- x_panel -->
                    <div class="x_panel tile fixed_height_420">
                      <!-- panel -->
                      <div id="tests-panel" class="panel panel-default">

                      <!-- x_title -->
                      <div class="x_title panel-heading">
                        <h2 id="tests-desc">Tables<small id="tests-desc-small"></small></h2>

                        <ul class="nav navbar-right panel_toolbox">
                          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                          </li>
                          <li><a class="close-link"><i class="fa fa-close"></i></a>
                          </li>
                        </ul>
                        <div class="clearfix"></div>

                      </div>
                      <!-- /x_title -->

                      </div>
                      <!-- /panel -->


					  <!-- x_content -->
                      <div class="x_content panel-body">

                        <!--
                          <table id="flight-sheet" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                              </tr>
                            </thead>
                          </table>
                        -->

<!-- Modal -->
<!--
<div id="myMODAL" class="modal fade" role="dialog">
  <div class="modal-dialog">
-->
    <!-- Modal content-->
    <!--
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Remove Table From Style</h4>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
        <button id="cancel" type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button id="remove" type="button" class="btn btn-default" data-dismiss="modal">Remove</button>
      </div>
    </div>

  </div>
</div>
-->

                        <div class="col-md-12 hidden-small">
                          <table id="sessions" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th>pkid</th>
                                <th>Table Name</th>
                                <th>Session</th>
                                <th>Head Judge</th>
                                <th>Second Judge</th>
                                <th>Number Beers</th>
                              </tr>
                            </thead>
                          </table>
                        </div>

                      </div>
                      <!-- /x_content -->


                    </div>
                    <!-- /x_panel -->

                    </div>
                    <!-- /col-md-6 -->


              </div>
            </div>
            <!-- /row -->





          </div>
        </div>
        <!-- /page content -->



        <!-- footer content -->
        <footer class="right_col_background">
          <div class="pull-right right_col_background">
            NC Brewers Cup
          </div>
          <div class="clearfix right_col_background"></div>
        </footer>
        <!-- /footer content -->

      </div>
    </div>



    <!-- jQuery -->
    <script src="static/js/jquery-3.3.1.min.js"></script>
	<!-- debounce -->
    <script src="static/js/jquery.ba-throttle-debounce.min.js"></script>
    <!-- Datatables Bootstrp Buttons RowGroup Select-->
	<script type="text/javascript" src="static/js/pdfmake.min.js"></script>
	<script type="text/javascript" src="static/js/vfs_fonts.js"></script>
	<script type="text/javascript" src="static/js/datatables.min.js"></script>
    <!-- DataTables Editor -->
    <script type="text/javascript" src="static/js/dataTables.editor.min.js"></script>
    <script type="text/javascript" src="static/js/editor.bootstrap.min.js"></script>
    <!-- Select2 -->
    <script type="text/javascript" src="static/js/editor.select2.js"></script>
    <script type="text/javascript" src="static/js/select2.min.js"></script>
    <!-- Bootstrap Toggle -->
    <script type="text/javascript" src="static/js/bootstrap-toggle.min.js"></script>
      <!-- Latest compiled and minified JavaScript -->
      <script src="static/js/bootstrap-select.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="/static/js/custom.min.js"></script>
    <!-- fieldType.toggle -->
    <script src="/static/js/field_type_toggle_plugin.js"></script>


<script>


var table;
var sessions_table;
var sheets_table;

var table_beer_count = {};

var head_judge = '';
var second_judge = '';

var hj_judge_likes = [];
var hj_judge_entries = [];
var hj_judge_dislikes = [];

var sj_judge_likes = [];
var sj_judge_entries = [];
var sj_judge_dislikes = [];


function drawMainTable() {
	table = $('#main-table').DataTable({
		ajax: {
			url: 'dt_flights',
			dataSrc: function (data) {
				for (var i=0; i<data.data.length; i++) {
					data.data[i].tables = JSON.parse(data.data[i].tables);
				}
				return data.data;
			}
		},
		dom: 'Bt',
		paging: false,
		//scrollY: 1500,
	    //select: {
    	//    style: "single",
      //  	selector: "td:last-child"
   		//},
   		order: [[0, 'asc']],
		columns: [
	        {
	        	data: 'number',
	        },
	        {
	        	data: 'category',
	        	visible: false
	        },
	        {
	        	data: 'style',
	        },
	        {
	        	data: 'count',
	        },
	        {
	        	data: 'tables',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			if (row.judged == 1) {
	        				return 'Judged'
	        			}
	        			table_num = '';
	        			if (data.sort()) {
	        				for (var i=0; i<data.length; i++) {
	        					var element = data[i];
	        					var temp = table_num ? ',' + element.split(' ').slice(-1)[0] : element.split(' ').slice(-1)[0];
	        			 		table_num = table_num + temp;
	        				}
	        			} else {
	        				table_num = '';
	        			}
	        			return  table_num;
	        		}
	        		return data;
	        	}
	        },
	        {
	        	data: 'cat_total',
	        	defaultContent: 0,
	        	visible: false
	        },
	    ],
	    rowGroup: {
	    	dataSrc: 'number',
            startRender: function ( rows, group ) {
                //console.log(group)
            	var sum = rows
                    .data()
                    .pluck('count')
                    .reduce( function (a, b) {
                    return a + b;
                	}, 0 );

            	var num_tables = rows
                    .data()
                    .pluck('tables')
                    .reduce( function (a, b) {

                    return a + (b ? b.length : 0);
                	}, 0 );


                var avg_beers = 0;

                if (rows[0].length > 0) {
                	avg_beers = num_tables / rows[0].length;
                }

                if (avg_beers) {
                	avg_beers = (sum / avg_beers).toFixed(1);
                }

				return $('<tr/>')
                    .append( '<td colspan="2	">Flight Number: ' + group + ' </td>' )
                    .append( '<td>Cat Total: ' + sum.toFixed(0) + '</td>' )
                    .append( '<td>' + avg_beers + '</td>' );
         	}
	    },
	    rowCallback: function (row, data) {
	    	//console.log(judge_entries);
	    	//console.log(judge_likes);
	    	//console.log(judge_dislikes);

	    	//$(row).data(data);

        var categoryId = data.category_id.toString();
        var color = '';
        var title = [];

	    	if (data.judged == 1) {
				$(row).addClass('strikeout');

      } else if (hj_judge_entries.indexOf(categoryId) > -1) {
				color = 'Red';
				title.push('Entry: ' + head_judge);
			}
      if (hj_judge_dislikes.indexOf(categoryId) > -1) {
        color = 'Red';
        title.push('Dislikes: ' + head_judge);
      }
      if (hj_judge_likes.indexOf(categoryId) > -1) {
        color = color === 'Red' ? 'Red' : 'Green';
        title.push('Likes: ' + head_judge);
			}
      if (sj_judge_entries.indexOf(categoryId) > -1) {
          color = 'Red';
          title.push('Entry: ' + second_judge);
      }
      if (sj_judge_dislikes.indexOf(categoryId) > -1) {
          color = 'Red';
          title.push('Dislikes: ' + second_judge);
			}
      if (sj_judge_likes.indexOf(categoryId) > -1){
        color = color === 'Red' ? 'Red' : 'Green';
        title.push('Likes: ' + second_judge);
			}

      if (title === '') {
				$(row).css('color', '');
				$(row).attr('title');
			} else {
        $(row).css('color', color);
				$(row).attr('title', title.join('<br>'));
      }
	    },
    	columnDefs: [
      		{
      			targets: ['_all'],
      			orderable: false
      		}

    	],
    	drawCallback: function( settings ) {
        	var api = this.api();
        	var category_totals = {};

			api.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
    			var data = this.data();

    			if (!category_totals[data.category_id]) {
    				category_totals[data.category_id] = 0;
    			}
    			category_totals[data.category_id] = category_totals[data.category_id] + data.count;
			} );

			api.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
    			var data = this.data();

    			data.cat_total = category_totals[data.category_id];
    			this.data(data);
			} );


        },
	    buttons: [
        /*
            {
                text: 'Initialize Flights',
                action: function ( e, dt, node, config ) {

    				init_flights(true);


                }
            },
            */
            {
                text: 'Use Registered Count',
                action: function ( e, dt, node, config ) {

    				get_styles_count(true);


                }
            },
            {
                text: 'Use Inventory Count',
                action: function ( e, dt, node, config ) {

					get_styles_count(false);

                }
            },
            {
                text: 'Save Flights',
                action: function ( e, dt, node, config ) {
                	save_flights();
                }
            },
            {
                text: 'Order by Category',
                action: function ( e, dt, node, config ) {
                	table.order([[1, 'asc'], [2, 'asc']]).draw(false);
                }
            },
            {
                text: 'Order by Cat Totals',
                action: function ( e, dt, node, config ) {
                	table.order([[5, 'desc'], [1, 'asc'], [2, 'asc']]).draw(false);
                }
            },
            {
                text: 'Refresh Flights Data',
                action: function ( e, dt, node, config ) {
                	table.draw(false);
                }
            },
    ]


	});


}



function drawSessionsTable() {
	sessions_table = $('#sessions').DataTable({
		ajax: 'dt_tables',
		dom: 't',
		rowId: 'pkid',
    scrollY: '500',
		paging: false,
   		order: [[2, 'asc']],
	    select: {
    	    style: "single",
        	selector: "td:first-child"
   		},
		columns: [
	        {
	        	data: 'pkid',
	        	defaultContent: '',
	        	visible: false
	        },
	        {
	        	data: 'name',
	        },
	        {
	        	data: 'session_name',
	        	visible: false
	        },
	        {
	        	data: 'head_judge',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			var bjcp = '';
	        			if (data.bjcp_rank) {
	        				bjcp = ' : BJCP ' + data.bjcp_rank;
	        			}

	        			var cat = '';
	        			if (data.categories.length > 0) {
	        				cat = ' (' + data.categories.join() + ')';
	        			}
	        			return data.firstname + ' ' + data.lastname + bjcp + cat;
	        		}
	        		return data;
	        	}
	        },
	        {
	        	data: 'second_judge',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			var bjcp = '';
	        			if (data.bjcp_rank) {
	        				bjcp = ' : BJCP ' + data.bjcp_rank;
	        			}

	        			var cat = '';
	        			if (data.categories.length > 0) {
	        				cat = ' (' + data.categories.join() + ')';
	        			}
	        			return data.firstname + ' ' + data.lastname + bjcp + cat;
	        		}
	        		return data;
	        	}
	        },
	        {
	        	data: 'total',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			return data.toFixed(1)
	        		}
	        		return data;
	        	}
	        },
	    ],
	    rowCallback: function (row, data, displayNum, displayIndex, dataIndex ) {
	    	var api = this.api();
	    	var total = table_beer_count[data.name];

	    	//console.log(table_beer_count);
	    	if (typeof total != 'undefined') {
	    		data.total = total;
	    		api.row(dataIndex).data(data);

	    	}
	    	if (data.name === 'Table 1') {
	    	//console.log(total)
	    	//console.log(data)
	    	}
	    },
	    initComplete: function () {
	    	var api = this.api();

			api.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
    			var data = this.data();
    			table_beer_count[data.name] = 0;
			} );

	    },
	    rowGroup: {
	    	dataSrc: 'session_name',
            startRender: function ( rows, group ) {
                return group +' ('+rows.count()+' Tables)';
            },
            startRender: function ( rows, group ) {
            	var sum = rows
                    .data()
                    .pluck('total')
                    .reduce( function (a, b) {
                    return a + b;
                	}, 0 );

				return $('<tr/>')
                    .append( '<td colspan="3">' + group +' ('+rows.count()+' Tables)</td>' )
                    .append( '<td>Total: ' + sum.toFixed(0) + '</td>' )
                    .append( '<td></td>' );
         	}
	    },


	});


}



function drawFlightSheetTable() {
	sheets_table = $('#flight-sheet').DataTable({
		dom: 'Bt',
		paging: false,
		ordering: false,
   		//order: [[0, 'asc']],
	    select: {
    	    style: "single",
        	selector: "td:first-child"
   		},
   		columnDefs: [
   			{
   				targets: 0,
   				visible: false
   			}
   		],
        buttons: [ {
            extend: 'excelHtml5',
            text: 'Flight Sheet',
            title: '',
            exportOptions: {
                columns: [ 1, 2, 3],
            }
        } ]

	});


}



function generate_flights(data) {

	$.ajax({
      	url: "/generate_flights",
      	type: 'post',
      	data: {data: data},
      	success: function(json) {
            var data = JSON.parse(json);
            console.log('generate_flights success')
            data = data.data;
        	//console.log(data);

        	sheets_table.clear().draw();

            for (table in data) {
            	//console.log('table', data[table].category_name);
            	sheets_table.row.add([table, table, '', data[table].category_name]);
            	sheets_table.row.add([table, 'Head Judge', '', data[table].head_judge]);
            	sheets_table.row.add([table, 'Judge', '', data[table].second_judge]);
            	sheets_table.row.add([table, ' ', ' ', ' ']);
            	sheets_table.row.add([table, 'Check Off', ' ', ' ']);

            	var beers = data[table].beers;
            	//console.log(beers);
            	for (i=0; i<beers.length; i++) {
            		sheets_table.row.add([table, '', beers[i].entry_id, beers[i].category + beers[i].sub_category + ' ' + beers[i].style_name])
            		if (beers[i].is_specialty == 1) {
            			sheets_table.row.add([table, '', '', beers[i].description]);
            		}
            	}
            	sheets_table.row.add([table, '', '', '']);
            }

            sheets_table.draw();
        },

      	error: function (jqXHR, exception) {
            console.log('generate_flights error')
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}



function init_flights() {

	$.ajax({
      	url: "/init_flights",
      	type: 'post',
      	success: function(json) {
            var data = JSON.parse(json);
        	//console.log(data);

            table.clear().draw();
			table.rows.add(data.data).draw();
        },

      	error: function (jqXHR, exception) {
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}




function save_flights() {

	var data = table.rows().data().toArray();
	$.ajax({
      	url: "/save_flights",
      	type: 'post',
      	data: {data: JSON.stringify(data)},
      	success: function(json) {
            var data = JSON.parse(json);
            //console.log(data);

            if (data.error && data.error.length > 0) {
            	console.log('Error trying to save judge pairs: ' + data.error);
            }

        },

      	error: function (jqXHR, exception) {
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}



function get_styles_count(full_inventory=true) {

	$.ajax({
      	url: "/get_styles_count",
      	type: 'post',
      	data: {data: full_inventory},
      	success: function(json) {
            var styles_count = JSON.parse(json);

            styles_count = styles_count.data;

            //reset table_beer_count counters
			for (var key in table_beer_count) {
   				if (table_beer_count.hasOwnProperty(key)) {
      				table_beer_count[key] = 0;
   				}
			}

            //iterate each row to get category counts and display them in the flights table and judges tables
			table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
   			 	var data = this.data();
   			 	//console.log(data)

   			 	category = styles_count[data.category_id];

   			 	if (category) {
   			 		var count = styles_count[data.category_id][data.sub_category_id];
   			 		if (typeof count == 'undefined') {
   			 			count = 0;
   			 		}
   			 	} else {
   			 		count = 0;
   			 	}


   			 	if (count) {
   			 		data.count = count;
   			 	} else {
   			 		data.count = 0;
   			 	}


   			 	//console.log(data.tables, count)

				//update table beer counter with newly loaded data
   			 	for (var i=0; i<data.tables.length; i++) {
   			 		table_beer_count[data.tables[i]] = table_beer_count[data.tables[i]] + count / data.tables.length;
   			 	}
   			 	//console.log(table_beer_count[data.tables[i]]);
   			 	//console.log(table_beer_count);
    			//save the number of entries counter to the flights table
    			this.data(data);
			} );

			table.draw(false);
			sessions_table.draw(false);

        },

      	error: function (jqXHR, exception) {
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}




$(document).ready(function() {
	drawMainTable();

	drawSessionsTable();
	drawFlightSheetTable();

	sessions_table.on('select', function ( e, dt, type, indexes ) {
		var data = sessions_table.row( { selected: true } ).data();
    //console.log(data);

    head_judge = data.head_judge.firstname + ' ' + data.head_judge.lastname
    second_judge = data.second_judge.firstname + ' ' + data.second_judge.lastname
		//get categories of entries a judge has
		hj_judge_entries = data.head_judge.categories;
    sj_judge_entries  = data.second_judge.categories;

		hj_judge_likes = data.head_judge.likes ? data.head_judge.likes.split(',') : [];
		sj_judge_likes = data.second_judge.likes ? data.second_judge.likes.split(',') : [];
		//judge_likes = hj.concat(sj);

		hj_judge_dislikes = data.head_judge.dislikes ? data.head_judge.dislikes.split(',') : [];
		sj_judge_dislikes = data.second_judge.dislikes ? data.second_judge.dislikes.split(',') : [];
		//judge_dislikes = hj.concat(sj);

		//console.log(judge_dislikes)
		table.draw(false);

	});


	sessions_table.on('deselect', function ( e, dt, type, indexes ) {
		var data = sessions_table.row( { selected: true } ).data();

		//reset the judge entries when no judge is selected
    head_judge = '';
    second_judge = '';
    hj_judge_entries = [];
		hj_judge_likes = [];
		hj_judge_dislikes = [];
    sj_judge_entries = [];
		sj_judge_likes = [];
		sj_judge_dislikes = [];

		table.draw(false);
	});



	table.on( 'select', function ( e, dt, type, indexes ) {
    	var sessions = sessions_table.row( { selected: true } ).data();

    	var data = table.row( { selected: true } ).data();
      var categoryId = data.category_id.toString();

    	if (sessions) {
    		// Make sure judge does not have entries in category and
    		// make sure table is not already in list - skip if so
    		if (hj_judge_entries.indexOf(categoryId) === -1 &&
    				hj_judge_dislikes.indexOf(categoryId) === -1 &&
            sj_judge_entries.indexOf(categoryId) === -1 &&
        		sj_judge_dislikes.indexOf(categoryId) === -1 &&
            data.tables.indexOf(sessions.name) == -1 &&
    				data.judged != 1
    				) {

    			//remove previous beer count for that style before adding new table
    			var num_beers = data.count ? (data.count / data.tables.length) : data.count;
    			for (var i=0; i<data.tables.length; i++) {
    				//console.log(data.tables[i]);
    				table_beer_count[data.tables[i]] = table_beer_count[data.tables[i]] - num_beers;
    				//need to find row in session table to update
    			}

				//add new table to selected row then deselect for visual
    			data.tables.push(sessions.name);
    			table.row( { selected: true } ).data(data);
    			table.rows().deselect();

    			if (!table_beer_count[sessions.name]) {
    				table_beer_count[sessions.name] = 0;
    			}

    			//recalc beer count for style after adding new table
    			var num_beers = data.count ? (data.count / data.tables.length) : data.count;
    			for (var i=0; i<data.tables.length; i++) {
    				//console.log(data.tables[i]);
    				table_beer_count[data.tables[i]] = table_beer_count[data.tables[i]] + num_beers;
    				//need to find row in session table to update
    			}

				//then remove these 2 lines
    			//sessions.total = table_beer_count[sessions.name];
    			//sessions_table.row( { selected: true } ).data(sessions);

    			sessions_table.draw(false);
    			table.draw(false);
    		} else {
    			//judge at the table has beers in this category so don't add
    			table.rows().deselect();
    		}
    	} else {
    		//code to remove table
    		//maybe an alert with tables to select

    		var data = table.row( { selected: true } ).data();

    		if (data.tables.length > 0 && data.judged != 1) {


				$('.modal-body').empty();


				for (var i=0; i<data.tables.length; i++) {
					$('<div class="radio"><label><input type="radio" ' +
					'name="optradio" value="' + data.tables[i] + '">' + data.tables[i] +
					'</label></div>').appendTo('.modal-body');
				}

    			$('#myMODAL').modal('show');
    		//no tables in the row
    		} else {
    			table.rows().deselect();
    		}

    	}


	} );

$('#myMODAL .modal-footer button').on('click', function(event) {
  var $button = $(event.target); // The clicked button

  $(this).closest('.modal').one('hidden.bs.modal', function() {
    // Fire if the button element
    //console.log('The button that closed the modal is: ', $button.attr('id'));

    if ($button.attr('id') === 'remove') {

    	var radioValue = $("input[name='optradio']:checked").val();
    	console.log(radioValue);

    	if (radioValue) {
    			var data = table.row( { selected: true } ).data();
    			//remove previous beer count for that style before removing table
    			var num_beers = data.count ? (data.count / data.tables.length) : data.count;
    			for (var i=0; i<data.tables.length; i++) {
    				//console.log(data.tables[i]);
    				table_beer_count[data.tables[i]] = table_beer_count[data.tables[i]] - num_beers;
    				//need to find row in session table to update
    			}




				//remove table from selected row then deselect for visual

    			index = data.tables.indexOf(radioValue);

    			//only remove if radio button value found in array
    			if (index > -1) {
    				data.tables.splice(index, 1);
    				table.row( { selected: true } ).data(data);
    			}

    			//if (!table_beer_count[sessions.name]) {
    			//	table_beer_count[sessions.name] = 0;
    			//}
          table_beer_count[sessions.name] = 0;
    			//recalc beer count for style after removing table
    			var num_beers = data.count ? (data.count / data.tables.length) : data.count;
    			for (var i=0; i<data.tables.length; i++) {
    				table_beer_count[data.tables[i]] = table_beer_count[data.tables[i]] + num_beers;
    			}

    			sessions_table.draw(false);
    			table.draw(false);

    	}
    }
    table.rows().deselect();
  });
});


$('#main-table').on('click', '.group', function() {

  var selected_table = sessions_table.row( { selected: true } ).data();

  //console.log(selected_table)

  if (selected_table) {
    var table_name = selected_table.name;
    console.log('tablename', selected_table.name)

  	var row = $(this).closest('tr');
    //console.log(row.text().split(' '))
  	var flightId = row.text().split(' ')[2];

    flightCategories = [];

    //table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
    //    var data = this.data();

        //console.log(data);
    //});


    var entryTotal = 0;
    //console.log('click', parseInt(cat_number))

    // Get indexes of rows contianing clicked category
    var indexes = table
      .rows()
      .indexes()
      .filter( function ( value, index ) {
        return flightId == table.row(value).data().number;
      } );

    //console.log(indexes);

    var data = table.rows(indexes).data();

    //console.log(data);

    // Get an array of categories assigned to flight.
    var flightCategories = [];
    $.each(data, function (index, value) {
        if (flightCategories.indexOf(value.category_id) === -1) {
          flightCategories.push(value.category_id);
        }
    });

    //console.log(flightCategories);

    var assigned_tables = data[0].tables;
    //console.log(assigned_tables);
    var judged = data[0].judged

    var selectedIndex = assigned_tables.indexOf(table_name);

    if (selectedIndex > -1) {
      //console.log('selectedIndex > -1')
      table.rows(indexes).every( function ( rowIdx, tableLoop, rowLoop ) {
          var d = this.data();
          entryTotal += d.count;

      } );

      // Subract number of entreis from each table.
      var num_beers = entryTotal ? (entryTotal / assigned_tables.length) : entryTotal;
      //console.log('num_beers', num_beers, assigned_tables)

      for (var i=0; i<assigned_tables.length; i++) {
        table_beer_count[assigned_tables[i]] = table_beer_count[assigned_tables[i]] - num_beers;
        //need to find row in session table to update
      }

      // Update table list by removing selected.
      assigned_tables.splice(selectedIndex, 1);
      //console.log('assigned_tables.length', assigned_tables.length)
      entryTotal = 0;
      table.rows(indexes).every( function ( rowIdx, tableLoop, rowLoop ) {
          var d = this.data();
          entryTotal += d.count;

          d.tables = assigned_tables; // update data source for the row

          this.invalidate(); // invalidate the data DataTables has cached for this row
      } );

      // Update the remaining tables with the number of entries.
      var num_beers = entryTotal ? (entryTotal / assigned_tables.length) : entryTotal;
      //console.log('num_beers', num_beers, assigned_tables)

      for (var i=0; i<assigned_tables.length; i++) {
        table_beer_count[assigned_tables[i]] = table_beer_count[assigned_tables[i]] + num_beers;
        //need to find row in session table to update
      }


      // Draw once all updates are done
    } else {
      //console.log('data.judged', judged)
      catFound = false;

      // Loop through flight categories to see if judge is not to be assigned.
      for (i=0; i < flightCategories.length; i++) {
        var catId = flightCategories[i].toString();

        if (hj_judge_entries.indexOf(catId) > -1 |
            hj_judge_dislikes.indexOf(catId) > -1 ||
            sj_judge_entries.indexOf(catId) > -1 ||
            sj_judge_dislikes.indexOf(catId) > -1) {
              catFound = true;
            }
      }

      // Allow assignment is category is not restricted, table not already assigned and not judged.
      if (!catFound &&
          assigned_tables.indexOf(table_name) == -1 &&
          judged != 1
          )
          {

            // Subract number of entreis from each table.
            table.rows(indexes).every( function ( rowIdx, tableLoop, rowLoop ) {
                var d = this.data();
                entryTotal += d.count;

            } );

            var num_beers = entryTotal ? (entryTotal / assigned_tables.length) : entryTotal;
            //console.log('num_beers', num_beers, assigned_tables)

            for (var i=0; i<assigned_tables.length; i++) {
              table_beer_count[assigned_tables[i]] = table_beer_count[assigned_tables[i]] - num_beers;
              //need to find row in session table to update
            }

          //add new table to selected row then deselect for visual
            assigned_tables.push(table_name);

            //console.log('new tables', assigned_tables)
            entryTotal = 0;
            table.rows(indexes).every( function ( rowIdx, tableLoop, rowLoop ) {
                var d = this.data();
                entryTotal += d.count;

                d.tables = assigned_tables; // update data source for the row

                this.invalidate(); // invalidate the data DataTables has cached for this row
            } );

            // Update the remaining tables with the number of entries.
            var num_beers = entryTotal ? (entryTotal / assigned_tables.length) : entryTotal;
            //console.log('num_beers', num_beers, assigned_tables)

            for (var i=0; i<assigned_tables.length; i++) {
              table_beer_count[assigned_tables[i]] = table_beer_count[assigned_tables[i]] + num_beers;
            }




          }

        }

        sessions_table.draw(false);
        table.draw(false);




      }

	//generate_flights(parseInt(cat_number));


});

});
</script>

</body>
</html>
