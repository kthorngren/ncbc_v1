<!DOCTYPE html>
<html>
  <head>
    
    <meta name = "viewport" content = "width = device-width, initial-scale = 1.0">
    <title id="page-title">NC Brewers Cup</title>
    <!-- Datatables Bootstrap Buttons RowGroup Select -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs-3.3.7/jszip-2.5.0/dt-1.10.18/b-1.5.2/b-html5-1.5.2/b-print-1.5.2/rg-1.0.3/sl-1.2.6/datatables.min.css"/>
    <!-- DataTables RowReorder -->
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/rowreorder/1.2.4/css/rowReorder.bootstrap.min.css"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">

    <!-- Custom Theme Style -->
    <link rel="stylesheet" type="text/css" href="static/css/custom.min.css">
    
  </head>

  <style>
  

  </style>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <!-- sidebar -->
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index" class="site_title"><i class="fa fa-home"></i> <span id="nav-title"> NC Brewers Cup</span></a>
            </div>
            <div class="clearfix"></div>
            <!-- sidebar menu -->
            <!-- /sidebar menu -->

          </div>
        </div>
        <!-- sidebar -->


        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav class="" role="navigation">
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>
            </nav>
          </div>
        </div>                
                


        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h4 id='main-title'>Manage Flights</h4>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">


				  <!-- col-md-6 -->
                  <div class="col-md-6 col-sm-6 col-xs-12">
                  
                    <!-- x_panel -->
                    <div class="x_panel tile fixed_height_420">
                      <!-- panel -->
                      <div id="tests-panel" class="panel panel-default">
                      
                      <!-- x_title -->
                      <div class="x_title panel-heading">
                        <h2 id="tests-desc">Flights<small id="tests-desc-small"></small></h2>

                        <ul class="nav navbar-right panel_toolbox">
                          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                          </li>
                          <li><a class="close-link"><i class="fa fa-close"></i></a>
                          </li>
                        </ul>
                        <div class="clearfix"></div>
                      
                      </div>
                      <!-- /x_title -->
                      
                      </div>
                      <!-- /panel -->


					  <!-- x_content -->
                      <div class="x_content panel-body">

                        <div class="col-md-12 hidden-small">
                          <table id="main-table" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th>Category</th>
                                <th>Sub Category</th>
                                <th>Number of Entries</th>
                                <th>Tables</th>
                              </tr>
                            </thead>
                          </table>
                        </div>
                        
                      </div>
                      <!-- /x_content -->  

                      
                    </div>
                    <!-- /x_panel -->

                    </div>
                    <!-- /col-md-6 -->



 
 
 				  <!-- col-md-6 -->
                  <div class="col-md-6 col-sm-6 col-xs-12">
                  
                    <!-- x_panel -->
                    <div class="x_panel tile fixed_height_420">
                      <!-- panel -->
                      <div id="tests-panel" class="panel panel-default">
                      
                      <!-- x_title -->
                      <div class="x_title panel-heading">
                        <h2 id="tests-desc">Sessions and Tables<small id="tests-desc-small"></small></h2>

                        <ul class="nav navbar-right panel_toolbox">
                          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                          </li>
                          <li><a class="close-link"><i class="fa fa-close"></i></a>
                          </li>
                        </ul>
                        <div class="clearfix"></div>
                      
                      </div>
                      <!-- /x_title -->
                      
                      </div>
                      <!-- /panel -->


					  <!-- x_content -->
                      <div class="x_content panel-body">

                        <div class="col-md-12 hidden-small">
                          <table id="sessions" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th>pkid</th>
                                <th>Table Name</th>
                                <th>Session</th>
                                <th>Head Judge</th>
                                <th>Second Judge</th>
                                <th>Number Beers</th>
                              </tr>
                            </thead>
                          </table>
                        </div>
                        
                      </div>
                      <!-- /x_content -->  

                      
                    </div>
                    <!-- /x_panel -->

                    </div>
                    <!-- /col-md-6 -->


              </div>
            </div>
            <!-- /row -->



           
            
          </div>
        </div>
        <!-- /page content -->



        <!-- footer content -->
        <footer class="right_col_background">
          <div class="pull-right right_col_background">
            NC Brewers Cup
          </div>
          <div class="clearfix right_col_background"></div>
        </footer>
        <!-- /footer content -->

      </div>
    </div>



    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<!-- debounce -->
    <script src="static/js/jquery.ba-throttle-debounce.min.js"></script>
    <!-- Datatables Bootstrp Buttons RowGroup Select-->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/v/bs-3.3.7/jszip-2.5.0/dt-1.10.18/b-1.5.2/b-html5-1.5.2/b-print-1.5.2/rg-1.0.3/sl-1.2.6/datatables.min.js"></script>
    <!-- DataTables RowReorder -->
	<script type="text/javascript" src="https://cdn.datatables.net/rowreorder/1.2.4/js/dataTables.rowReorder.min.js"></script>
      <!-- Latest compiled and minified JavaScript -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <!-- Quill -->
    <script type="text/javascript" src="https://cdn.quilljs.com/1.2.2/quill.min.js"></script>
    <script type="text/javascript" src="static/js/editor.quill_text.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="/static/js/custom.min.js"></script>
    <!-- fieldType.toggle -->
    <script src="/static/js/field_type_toggle_plugin.js"></script>


<script>


var table;
var sessions_table;



function drawMainTable() {
	table = $('#main-table').DataTable({
		ajax: 'dt_flights',
		dom: 'Bt',
		paging: false,
	    select: {
    	    style: "single",
        	selector: "td:first-child"
   		},
   		order: [[0, 'asc'], [1, 'asc']],
		columns: [
	        {
	        	data: 'category',
	        	visible: false
	        },
	        {
	        	data: 'style',
	        },
	        {
	        	data: 'count',
	        },
	        {
	        	data: 'tables',
	        },
	    ],
	    rowGroup: {
	    	dataSrc: 'category',
            startRender: function ( rows, group ) {
            	var sum = rows
                    .data()
                    .pluck('count')
                    .reduce( function (a, b) {
                    return a + b;
                	}, 0 );
                    
				return $('<tr/>')
                    .append( '<td colspan="1">' + group + '</td>' )
                    .append( '<td>Cat Total: ' + sum.toFixed(0) + '</td>' );
         	}       
	    },
    columnDefs: [
      {
      	targets: ['_all'],
      	orderable: false
      }

    ],
	    buttons: [
            {
                text: 'Use Registered Count',
                action: function ( e, dt, node, config ) {
    	
    				get_styles_count(true);
    	

                }
            },        
            {
                text: 'Use Inventory Count',
                action: function ( e, dt, node, config ) {
                
					get_styles_count(false);
					
                }
            },        
            {
                text: 'Save Flights',
                action: function ( e, dt, node, config ) {
                
    				var session_number = table.row( { selected: true } ).data()['pkid'];
    	
					reset_session_judges(session_number);
                }
            },        
    ] 
	    

	});


}



function drawSessionsTable() {
	sessions_table = $('#sessions').DataTable({
		ajax: 'dt_tables',
		dom: 't',
		rowId: 'pkid',
		paging: false,
   		order: [[2, 'asc']],
		columns: [
	        {
	        	data: 'pkid',
	        	defaultContent: '',
	        	visible: false
	        },
	        {
	        	data: 'name',
	        },
	        {
	        	data: 'session_name',
	        	visible: false
	        },
	        {
	        	data: 'head_judge',
	        	defaultContent: '',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			return data.firstname + ' ' + data.lastname
	        		}
	        	}
	        },
	        {
	        	data: 'second_judge',
	        	defaultContent: '',
	        	render: function (data, type, row) {
	        		if (type === 'display') {
	        			return data.firstname + ' ' + data.lastname
	        		}
	        	}
	        },
	        {
	        	data: 'total',
	        },
	    ],
	    rowGroup: {
	    	dataSrc: 'session_name',
            startRender: function ( rows, group ) {
                return group +' ('+rows.count()+' Tables)';
            },
            startRender: function ( rows, group ) {
            	var sum = rows
                    .data()
                    .pluck('total')
                    .reduce( function (a, b) {
                    return a + b;
                	}, 0 );
                    
				return $('<tr/>')
                    .append( '<td colspan="3">' + group +' ('+rows.count()+' Tables)</td>' )
                    .append( '<td>Total: ' + sum.toFixed(0) + '</td>' );
         	}       
	    },
	    buttons: [
            {
                text: 'Generate Table Assignments',
                action: function ( e, dt, node, config ) {
    				generate_tables();
                }
            },        
            {
                text: 'Save Table Assignments',
                action: function ( e, dt, node, config ) {
                	save_tables();
                }
            },        
    ] 
	    

	});


}




function save_pairs(data) {

	$.ajax({
      	url: "/save_pairs",
      	type: 'post',
      	data: {data: JSON.stringify(data)},
      	success: function(json) {
            var data = JSON.parse(json);
            //console.log(data);
            
            if (data.error) {
            	alert('Error trying to save judge pairs: ' + data.error);
            }
            
        },

      	error: function (jqXHR, exception) {
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}



function get_styles_count(full_inventory=true) {

	$.ajax({
      	url: "/get_styles_count",
      	type: 'post',
      	data: {data: full_inventory},
      	success: function(json) {
            var styles_count = JSON.parse(json);
            
            styles_count = styles_count.data;
            
			table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
   			 	var data = this.data();
   			 	//console.log(data)
   			 	
   			 	category = styles_count[data.category_id];
   			 	
   			 	if (category) {
   			 		var count = styles_count[data.category_id][data.sub_category_id];
   			 	} else {
   			 		count = 0;
   			 	}
   			 	
   			 	
   			 	if (count) {
   			 		data.count = count;
   			 	} else {
   			 		data.count = 0;
   			 	}
   			 	
    			
    			this.data(data);
			} );    
			
			table.draw();        
			
            
        },

      	error: function (jqXHR, exception) {
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}




function reset_session_judges(session_number) {

	$.ajax({
      	url: "/get_session_judges",
      	type: 'post',
      	data: {session_number: session_number},
      	success: function(json) {
            var data = JSON.parse(json);

            judges_table.clear().draw();
            hj_table.clear().draw();
            sj_table.clear().draw();
            
            for (i=0; i<data.all.length; i++) {
            	data.all[i].order = 0;
            }
            
            judges_table.rows.add(data.all).draw();
        },

      	error: function (jqXHR, exception) {
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}




function get_session_judges(session_number) {

	$.ajax({
      	url: "/get_session_judges",
      	type: 'post',
      	data: {session_number: session_number},
      	success: function(json) {
            var data = JSON.parse(json);
            //console.log(data);
            judges_table.clear().draw();
            hj_table.clear().draw();
            sj_table.clear().draw();
            
            for (i=0; i<data.all.length; i++) {
            	data.all[i].order = 0;
            }
            //console.log(typeof data.pairing == 'undefined');
            if (typeof data.pairing == 'undefined' || data.pairing.length === 0) {
            	judges_table.rows.add(data.all).draw();
            } else {
            	var pairs = data.pairing[0];
            	
            	var judges = JSON.parse(pairs.judges);
            	var head_judge = JSON.parse(pairs.head_judge);
            	var second_judge = JSON.parse(pairs.second_judge);
            	
            	//console.log('judges', judges)
            	
            	judges_table.rows.add(judges).draw();
            	hj_table.rows.add(head_judge).draw();
            	sj_table.rows.add(second_judge).draw();
            }
        },

      	error: function (jqXHR, exception) {
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}



$(document).ready(function() {
	drawMainTable();
	
	drawSessionsTable();

	
	

});
</script>

</body>
</html>

