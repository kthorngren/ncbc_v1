<!DOCTYPE html>
<html>
  <head>

    <meta name = "viewport" content = "width = device-width, initial-scale = 1.0">
    <title id="page-title">NC Brewers Cup</title>
    <!-- Datatables Bootstrap Buttons RowGroup Select -->
    <link rel="stylesheet" type="text/css" href="static/css/datatables.min.css"/>
    <!-- DataTables Editor -->
    <link rel="stylesheet" type="text/css" href="static/css/editor.bootstrap.min.css">
    <!-- Autofill -->
    <link rel="stylesheet" type="text/css" href="static/css/autoFill.bootstrap.min.css"/>
    <!-- Bootstrap Toggle -->
    <link rel="stylesheet" type="text/css" href="static/css/bootstrap-toggle.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" type="text/css" href="static/css/select2.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="static/css/font-awesome.min.css">
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="static/css/bootstrap-select.min.css">

    <!-- Custom Theme Style -->
    <link rel="stylesheet" type="text/css" href="static/css/custom.min.css">

  </head>

  <style>

.left-half {
  float: left;
  width: 50%;}

.right-half {
  float: right;
  width: 50%;
}
  </style>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <!-- sidebar -->
        <div class="col-md-3 left_col">
          <div class="left_col scroll-view">
            <div class="navbar nav_title" style="border: 0;">
              <a href="index" class="site_title"><i class="fa fa-home"></i> <span id="nav-title"> NC Brewers Cup</span></a>
            </div>
            <div class="clearfix"></div>
            <!-- sidebar menu -->
            <!-- /sidebar menu -->

          </div>
        </div>
        <!-- sidebar -->


        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav class="" role="navigation">
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>
            </nav>
          </div>
        </div>



        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h4 id='main-title'>Define Flights</h4>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">

                <div class="x_panel">
                  <div class="x_title">
                    <h2 id="table-title">Flights</h2>
                    <ul class="nav navbar-right panel_toolbox">
                      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                      </li>
                      <!--
                      <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                        <ul class="dropdown-menu" role="menu">
                          <li><a href="#">Settings 1</a>
                          </li>
                          <li><a href="#">Settings 2</a>
                          </li>
                        </ul>
                      </li>
                      -->
                      <li><a class="close-link"><i class="fa fa-close"></i></a>
                      </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <p class="text-muted font-13 m-b-30">Place instructions here</p>
            </div>
            <div class="row">
              <table id="locations-table" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">

              </table>

            <hr>

            <div>Unassigned Flights: 
              <span id="unassigned"></span>
            </div>

            </div>
                          <table id="main-table" class="table table-hover table-bordered table-striped" cellpadding="0" width="100%">
                            <thead>
                              <tr>
                                <th>pkid</th>
                                <th>Number</th>
                                <th>Qty</th>
                                <th>Sub Category</th>
                                <th>Category</th>
                                <th>Total Category</th>
                                <th>Location</th>
                                <th>Judges w/ Entries</th>
                              </tr>
	                        </thead>
                          </table>
                </div>
                <!-- /x_panel -->

              </div>
            </div>
            <!-- /row -->




          </div>
        </div>
        <!-- /page content -->



        <!-- footer content -->
        <footer class="right_col_background">
          <div class="pull-right right_col_background">
            NC Brewers Cup
          </div>
          <div class="clearfix right_col_background"></div>
        </footer>
        <!-- /footer content -->

      </div>
    </div>



    <!-- jQuery -->
    <script src="static/js/jquery-3.3.1.min.js"></script>
	<!-- debounce -->
    <script src="static/js/jquery.ba-throttle-debounce.min.js"></script>
    <!-- Datatables Bootstrp Buttons RowGroup Select-->
	<script type="text/javascript" src="static/js/pdfmake.min.js"></script>
	<script type="text/javascript" src="static/js/vfs_fonts.js"></script>
	<script type="text/javascript" src="static/js/datatables.min.js"></script>
    <!-- DataTables Editor -->
    <script type="text/javascript" src="static/js/dataTables.editor.min.js"></script>
    <script type="text/javascript" src="static/js/editor.bootstrap.min.js"></script>
    <!-- Autofill -->
    <script type="text/javascript" src="static/js/dataTables.autoFill.min.js"></script>
    <script type="text/javascript" src="static/js/autoFill.bootstrap.min.js"></script>
    <!-- Select2 -->
    <script type="text/javascript" src="static/js/editor.select2.js"></script>
    <script type="text/javascript" src="static/js/select2.min.js"></script>
    <!-- Natrural -->
    <script type="text/javascript" src="static/js/natural.js"></script>
    <!-- Bootstrap Toggle -->
    <script type="text/javascript" src="static/js/bootstrap-toggle.min.js"></script>
      <!-- Latest compiled and minified JavaScript -->
      <script src="static/js/bootstrap-select.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="/static/js/custom.min.js"></script>
    <!-- fieldType.toggle -->
    <script src="/static/js/field_type_toggle_plugin.js"></script>


<script>
var editor;
var table;
var styles_count = {};
var dispalyRegistered = false;
var totalCategory = {};
var judgeCategories = {};

// covid-19 testing - remove next year
var useEight = false;
var allowGreaterEight = false;

// Todo: get this via ajax
var locationsMap = {
  0: '',
  1: 'Triangle',
  2: 'Charlotte',
  3: 'Asheville'
}

// Todo: make this programatic
var locAbbr = {
  105: 'rtp',
  106: 'rtp',
  107: 'clt',
  108: 'clt',
  109: 'avl',
  110: 'avl'
}

function get_styles_count(full_inventory=true) {

	$.ajax({
      	url: "/get_styles_count",
      	type: 'post',
      	data: {data: full_inventory},
      	success: function(json) {
            var styles_count = JSON.parse(json);

            styles_count = styles_count.data;
            totalCategory = {};

            table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
         			 	var data = this.data();
                var count = 0;
                var catSubcat = data.sub_category_id.match(/[a-z]+|[^a-z]+/gi);
                var category = data.category;

                if (catSubcat.length === 2) {
                  var category_id = catSubcat[0];
                  var sub_category_id = catSubcat[1];
                  if (styles_count.hasOwnProperty(category_id)) {
                    if (styles_count[category_id].hasOwnProperty(sub_category_id)) {
                      count = styles_count[category_id][sub_category_id]
                    }
                  }
                  data.count = count;

                  // Track total entries for the category
                  if ( !totalCategory.hasOwnProperty(category) ) {
                    totalCategory[category] = 0;
                  }
                  totalCategory[category] += count;
                }

            });
            table.rows().invalidate().draw(false);

        },

      	error: function (jqXHR, exception) {
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}


function get_judge_categories() {
  judgeCategories = {};
  $.ajax({
      url: "/get_judge_categories",
      success: function(json) {
          judgeCategories = JSON.parse(json);


      },

      error: function (jqXHR, exception) {
        //set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      },
  });
}



function initMainEditor() {

editor = new $.fn.dataTable.Editor(
{
    table: "#main-table",
	ajax: "dt_define_flights",
	idSrc: 'pkid',
    fields: [
        {
            name: "pkid",
            label: "pkid:",
            type: "hidden"
        },
        {
            name: "number",
            label: "Number:"
        },
        {
            name: "category",
            label: "Category:",
            type:  "select",
        },

    ]
});

// Activate an inline edit on click of a table cell
$('#main-table').on( 'click', 'tbody td.editor', function (e) {
    editor.inline( this, {
        onBlur: 'submit'
    } );
} );



editor
    .on( 'postCreate postRemove', function () {
        // After create or edit, a number of other rows might have been effected -
        // so we need to reload the table, keeping the paging in the current position
        table.ajax.reload( null, false );
    } )
    .on( 'initCreate', function () {
        // Enable order for create
        editor.field( 'pkid' ).disable();
    } )
    .on( 'initEdit', function () {
        // Disable for edit (re-ordering is performed by click and drag)
        editor.field( 'pkid' ).disable();
    } )
    .on( 'preSubmit', function (e, data, action) {
      $.each( data.data, function ( key, values ) {
        if (data.data[ key ][ 'category' ]) {
          data.data[ key ][ 'number' ] = Number( data.data[ key ][ 'category' ].split(' ')[0] );
        }
      } );
    })
    .on( 'submitComplete', function (e, data, action) {
      get_styles_count(dispalyRegistered);
    });
}

function save_judging_location(category, fk_judge_locations) {

  $.ajax({
      url: "/save_judge_location",
      type: 'post',
      data: {category: category, fk_judge_locations: fk_judge_locations},
      success: function(json) {
        //console.log(json)
        $('#main-table').DataTable().ajax.reload(function ( json ) {
          get_styles_count(dispalyRegistered);
        }, false);
        
      },

      error: function (jqXHR, exception) {
        //set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      },
  });
}


function drawLocationsTable() {
  $('#locations-table').DataTable({
    ajax: 'get_locations_table',
    dom: 'Blftirp',
		paging: false,

  		columns: [
          {
            data: 'location_name',
            title: 'Location'
          },
          {
            data: 'judge_pairs',
            title: '# Judge Pairs'
          },
          {
            data: 'judge_tables',
            defaultContent: '',
            title: '# Judging Tables (4 Sessions)'
          },
          {
            data: 'beers',
            defaultContent: '',
            title: 'Beers/Judge Pair for day'
          },
          {
            data: 'entries',
            defaultContent: '',
            title: 'Total Entries'
          },
          {
            data: 'categories',
            defaultContent: '',
            title: 'Number of Categories'
          },
          {
            data: 'flights',
            defaultContent: '',
            title: 'Number of Flights/Tables'
          },
      ],
      buttons: ['excel'],
      
      rowCallback: function (row, data) {
        var api = this.api();
        var location = data.location_pkid
        var flights = table.rows( function ( idx, data, node ) {
                          return data.fk_judge_locations === location ?
                              true : false;
                      } )
                      .data()
                      .toArray();
        //console.log(flights)
        
        data.entries = 0;
        data.flights = 0;

        categories = [];
        flightCounts = {};
        entries = 0;
        numFlights = 0;

        for (i=0; i<flights.length; i++) {

          var catId = flights[i].category_id;
          var count = flights[i].count;
          //console.log(count)
          entries += count;

          if ( !flightCounts.hasOwnProperty(catId) ) {
            flightCounts[catId] = 0;
          }
          flightCounts[catId] += count;

          if ( !categories.includes(catId) ) {
            categories.push(catId);
          }
        }

        for (const [key, value] of Object.entries(flightCounts)) {

          console.log(key, value)

          if (value > 17) {
            numFlights += Math.ceil(value / 15);  // Round up the # of flights
          } else {
            numFlights += 1;  // 17 or less is 1 flight
          }

        }
        console.log(numFlights)

        data.entries = entries;
        data.flights = Math.ceil(numFlights);

        // covid-19 code, remove next year
        if ( !allowGreaterEight && data.judge_pairs > 8) {
          data.judge_pairs = 8;
        } 
        
        if ( useEight ) { 
          if ( (allowGreaterEight && data.judge_pairs <= 8) || !allowGreaterEight ) {
            data.judge_pairs = 8;
          }
        }
        // end c-19 code

        data.judge_tables = data.judge_pairs * 4;
        data.beers = (data.entries / data.judge_pairs).toFixed(1);
        data.categories = categories.length;
        api.row(row).data( data )
      }


	});


}

function onlyUnique(value, index, self) { 
    return self.indexOf(value) === index;
}


function drawMainTable() {
  table = $('#main-table').DataTable({
		ajax: 'dt_define_flights',
		dom: 'Blftirp',
    rowId: 'pkid',
    scrollY: 500,
    autoFill: {
      columns: 1,
      editor: editor
    },
		paging: false,
	    //select: {
    	//    style: "multi+shift",
      //  	selector: "td:first-child"
   		//},
   		order: [[1, 'asc'],[3, 'asc']],
       rowGroup: {
	    	dataSrc: 'category',
            startRender: function ( rows, group ) {

              var total = rows
                    .data()
                    .pluck('count')
                    .reduce( function (a, b) {
                        return a + b*1;
                    }, 0);
              
              //totalCategory[group] = total;

              var category_id = rows.data().pluck('category_id')[0];

              var judges = judgeCategories[category_id];
              var judge = 0;
              var judgeTitle = [];
              var steward = 0;
              var stewardTitle = [];



              if (judges) {
                for (i=0; i<judges.length; i++) {
                  var volunteer = judges[i]
                  var volLocation = volunteer['fk_sessions_list'].split(',')[0]; // Todo: choose a better way to get location

                  if (volunteer.judge == 1) {
                    judge++;
                    judgeTitle.push(volunteer.firstname + ' ' + volunteer.lastname + ' (' + locAbbr[volLocation] + ')')
                  } else {
                    steward++;
                    stewardTitle.push(volunteer.firstname + ' ' + volunteer.lastname + ' (' + locAbbr[volLocation] + ')')
                  }
                }
              }

              var fk_judge_locations = rows.data().pluck('fk_judge_locations')[0];
              var select = $('<select data-category="' + group + '""><option value="0"></option></select>')

              // Todo:  Get this from the JSON response
              var locations = [{"name": "Triangle", "pkid": 1}, 
                                {"name": "Charlotte", "pkid": 2}, 
                                {"name": "Asheville", "pkid": 3}
                              ];

              for (i=0; i<locations.length; i++) {
                var location = locations[i];
                var selected = fk_judge_locations == location.pkid ? ' selected ' : '';
                select.append( '<option value="' + location.pkid + '" ' + selected + '>'+ location.name + '</option>' );
              }

              return $('<tr/>')
                .append( '<td colspan="2">' + group + ' - Entries: ' + total + '</td>' )
                .append( '<td class="group-location"><div class="left-half"><span>Location: ' + $(select).prop('outerHTML') + '</span></div><div class="right-half"><span title="' + judgeTitle.join('\n') + '">' + ' Judges: ' + judge + '</span><span title="' + stewardTitle.join('\n') + '"> Stewards: ' + steward + '</span></div></td>' );
            },
      },
  		columns: [
	        {
	        	data: 'pkid',
            visible: false,
            orderable: false,
	        },
	        {
            data: 'number',
            visible: false,
            orderable: false,
	        },
          {
            data: 'count',
            orderable: false,
          },
          {
	        	data: 'style', type: 'natural',
            orderable: false,
	        },
	        {
            data: 'category',
            className: 'editor',
            orderable: false,
          },
          {
            data: null,
            visible:false,
            orderable: false,
            render: function(data, type, row) {
              return totalCategory[row.category] === undefined ? 0 : totalCategory[row.category];
            }
          },
          {
            data: null,
            visible:false,
            orderable: false,
            render: function(data, type, row) {
              return locationsMap[row.fk_judge_locations];
            }
          },
          {
            data: null,
            visible:false,
            orderable: false,
            render: function(data, type, row) {
              var category_id = row.category_id;
              var judges = judgeCategories[category_id];
              var locationPkid = [];

              if (judges) {
                for (i=0; i<judges.length; i++) {
                  var volunteer = judges[i]
                  var volLocation = volunteer['fk_sessions_list'].split(',')[0]; // Todo: choose a better way to get location

                  if ( !locationPkid.includes(volLocation) && volunteer.judge == 1 ) {
                    locationPkid.push(volLocation);
                  }
                }
              }

              var locations = [];

              for (i=0; i<locationPkid.length; i++) {
                if( !locations.includes(locAbbr[locationPkid[i]])) {
                  locations.push(locAbbr[locationPkid[i]]);
                }
              }

              return locations.join(',');
            }
          },
	    ],

      buttons: [

            {
                text: 'Initialize Flights',
                enabled: false,  // Todo: re-aneble next year, dont want to accidentally click it now
                action: function ( e, dt, node, config ) {

    				        init_flights(true);


                }
            },
            {
                text: 'Use Registered Count',
                action: function ( e, dt, node, config ) {
                  dispalyRegistered = true;
    				          get_styles_count(dispalyRegistered);


                }
            },
            {
                text: 'Use Inventory Count',
                action: function ( e, dt, node, config ) {
                  dispalyRegistered = false;
					             get_styles_count(dispalyRegistered);

                }
            },
            {
                text: 'Order by Category Total',
                action: function ( e, dt, node, config ) {
                  dt.order([[5, 'desc'], [1, 'asc'], [3, 'asc']]).draw();

                }
            },
            {
                text: 'Order by Category Number',
                action: function ( e, dt, node, config ) {
                  dt.order([[1, 'asc'], [3, 'asc']]).draw();

                }
            },
            {
              extend: 'excelHtml5',
              //exportOptions: { orthogonal: 'export' }
            }
        ],
        initComplete: function (settings, json) {
          var api = this.api();
          var jsonOptions = json.options;
          var options = [];

          for (i=0; i<jsonOptions.length; i++) {
                  var option = jsonOptions[i];
                    //var value = Number(option.split(' ')[0]);
                    options.push( {label: option, value: option})
                }   

          editor.field('category').update(options);


        }


	});

  table.on('draw', function () {
    $('.group-location').off().on('change', 'select', function () {
            var category = $(this).data('category');
            //console.log(category)
            var val = $(this).val();

            save_judging_location(category, val);


          });

          // todo: use this to group and find unassigned flights that have entries:
          // totalCategory[row.category] === undefined ? 0 : totalCategory[row.category];
          var cat = table.rows( function ( idx, data, node ) {
                          return data.fk_judge_locations === 0 && data.count > 0 ?
                              true : false;
                      } )
                      .data()
                      .pluck('category');

            $('#unassigned').html(cat.filter(onlyUnique).length);
            $('#locations-table').DataTable().draw();
  });

}

function init_flights() {

	$.ajax({
      	url: "/init_flights",
      	type: 'post',
      	success: function(json) {

          table.ajax.reload();
        },

      	error: function (jqXHR, exception) {
      		//set_status('Error collecting version info: ' + get_xhr_error(jqXHR, exception));
      	},
    });
}



$(document).ready(function() {
  initMainEditor();
  get_judge_categories()
  drawMainTable();
  drawLocationsTable();


});
</script>

</body>
</html>
